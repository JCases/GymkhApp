import * as bcrypt from 'bcryptjs';
import moment from 'moment';
import path from 'path';
import { Sequelize } from 'sequelize-typescript';

import Environment from './../utils/environment';

import Company from './company.model';
import Gymkhana from './gymkhana.model';
import Phase from './phase.model';
import Status from './status.model';
import User from './user.model';
import UsersGymkhanas from './usersGymkhanas.model';

interface ISequelizeModels {
  User: typeof User;
  Gymkhana: typeof Gymkhana;
  Company: typeof Company;
  Phase: typeof Phase;

  UsersGymkhana: typeof UsersGymkhanas;
  Status: typeof Status;
}

class Database {
  private mModels: ISequelizeModels;
  private mSequelize: Sequelize;

  constructor() {
    this.mSequelize = new Sequelize(Environment.dbName!, Environment.dbUser!, Environment.dbPass!, {
      ...Environment.dbConfig,
      storage: path.resolve(__dirname, 'database.db'),
      sync: { force: false },
      modelPaths: [`${__dirname}*/*.model.ts`],
    });

    this.mModels = ({} as ISequelizeModels);
    this.mModels = this.getModels();

    this.mSequelize.sync().then(async (result: any) => {
      if ((await this.mModels.User.count()) === 0) {
        // FIXME: Example Inserts in Database
        const user = await this.mModels.User.create({ email: 'admin@admin.com', password: bcrypt.hashSync('admin'), nick: 'admin', city: 'Alicante', image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEwAACxMBAJqcGAAABi1JREFUeJzt2ltsFFUcx/HfmZmd2e4Wdrf0Xmy404RwiZdIfQESTSSGRNSQCCaKPhlj8BIwRjQSufhk0PhCIyoxPIjEhETRF+SBB0ECIZpwaUWkQCm0pbdtd2c7c44PIAItFHrOIMv//3ncDL/ZZL9sZ2cXYIwxxhhj5Igoxyu+Wj9PCLFISTQIyDQsyx7rlhX3JmBcfLrJ53evUkpJpUS/CNEsEG5vf3rVzqjOFUkA5V9vWAZgrQXMNrUpEnHYZSlTc0UlHApyIp//vH3pG2tMbxsNILV9U8Ybkt8AeMrkLkA7gH9Jf6gduez89udWnza1aZkaqt66oSLmy32I4MVnl1lerFolksfrdm429qfQTABbtsQCIXdZFmYZ2WM3ZbtuXJa4B7Fjh2tiz0gAlV7nasuyGk1ssdEJz01Vxy98b2RLdyCz5eNULBa2wsJ4E0/oZvga4HoqCJU/JB+4tOTVczo72u8Ajhcuj/rFZ8MJxxYxGWzU3THxJ2CxgQ02BsK2ntDdMBHAPAMbbAyE7VTobmgHICCrdTfYGMUsR3fCwDuAFdPfYGMhDNzHM3YjiBUnDoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DqCICaW0NziAIhbTf/05gGJW55Rob3AARWxp+RTtDQ6gSHlS4aX6Wdo7HECRemviHEi+CKRpvpfB87UNCIJAe4sDKDJzYuPQNPtxAEAul9Pec7QX2F0hpMKKCVOwZurDVx/r6xvQ3uUA7nGuVHg0UY4PZzSiwv3vY18Qhujp7dXev2sBTB6XwcKqSZg6vgxJx73jf98rC2gt6BdfDBxhoTxWgsZMNaYmMyMec/FCJ5SBi8DIA6gpKcXauQuwqHpy1KciI5sdQGdXFyxH/+WLNIDZmSo0NS5Byo1HeRpScrk8/m49CwUg7nnae5EFUFNSyi++YT09fThzrg1SSgBAaTKhvRlZAGsaHuMX35DBwRzaL3agvz979TEBoCyT1t6OJIBaN4HqvgAnWk6iNJmA53lwbBtKiChOd/9RCmEYIu/7yGYH4fv+sEPS6TRcN6Z9qkgCeDBRDgDI533k88OfPNPjOA5qayoxGA5pb0VyJ7DOTUYxywAIYWFS/UQ4joMzA33ae5G8A8QF32GOguM4mFQ/EckrF39Hus7rb2ovjKDg2RAADPxgheHyBV86nUZtTSWcaz77/9z2p/Z2JAGcVT5mzpiGnt5eZPsHkC/4CIOQg7hNQgjYtgXPi6M0mUBZJgXXvf7u6dGeDhzoOKt9rkgC2Hv+FIK5C1FVWYGqyoooTkGaVAqbft8HJVHQ3dL+Y62kDG98LBsU8EXLId1pdhOfHduPQ5faoCxoXwRoByAs0THS41ubD2O/gbcodr2m5kNoar7yn0visO6e/juAEHtGejxQEq/t/wF7zv+lewoGoCs/iDd/+wmbj/569TFb4EfdXe1rgDCu3nEG1XIIa9htvlwY4PUDu/Fk3TS8Mv0hzErz9cCdaunvwq7WE/j21B8YCK658SNldyDdHbr7Ru7NVmzbsFsoLB7tOM+2Ueq4cCz7lsdNTqZIf48QKIW+go+T2W5c8gdHPkjIty+++P4nuucy8imgo77wTOVppx2wUrc6zg9D+OHov2O7kMuOegxlSsq9HaUzPzWxZeaW3aJ1+ZhUj8hQ5Y3ssVs5UvCcZ7Fs2bBPX2Nh7J7tuZc/aAnz8RlKqTZTm2yY7wK7sKB3xbvdpgYj+X62cttHG5USqwSE/i8WGBTUQaWwrnPlWu2r/htF+gV91Zfrl0hYL1hAQ2iH40V4e98SKSGaBdAV5XO7pwkEQqFbWeqYlOKXrpXvHf+/nxJjjDHGGLuP/AMeZJVUQaGa2gAAAABJRU5ErkJggg==' });
        const company = await this.mModels.Company.create({ name: 'TestCompany', image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEwAACxMBAJqcGAAABi1JREFUeJzt2ltsFFUcx/HfmZmd2e4Wdrf0Xmy404RwiZdIfQESTSSGRNSQCCaKPhlj8BIwRjQSufhk0PhCIyoxPIjEhETRF+SBB0ECIZpwaUWkQCm0pbdtd2c7c44PIAItFHrOIMv//3ncDL/ZZL9sZ2cXYIwxxhhj5Igoxyu+Wj9PCLFISTQIyDQsyx7rlhX3JmBcfLrJ53evUkpJpUS/CNEsEG5vf3rVzqjOFUkA5V9vWAZgrQXMNrUpEnHYZSlTc0UlHApyIp//vH3pG2tMbxsNILV9U8Ybkt8AeMrkLkA7gH9Jf6gduez89udWnza1aZkaqt66oSLmy32I4MVnl1lerFolksfrdm429qfQTABbtsQCIXdZFmYZ2WM3ZbtuXJa4B7Fjh2tiz0gAlV7nasuyGk1ssdEJz01Vxy98b2RLdyCz5eNULBa2wsJ4E0/oZvga4HoqCJU/JB+4tOTVczo72u8Ajhcuj/rFZ8MJxxYxGWzU3THxJ2CxgQ02BsK2ntDdMBHAPAMbbAyE7VTobmgHICCrdTfYGMUsR3fCwDuAFdPfYGMhDNzHM3YjiBUnDoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DoA4DqCICaW0NziAIhbTf/05gGJW55Rob3AARWxp+RTtDQ6gSHlS4aX6Wdo7HECRemviHEi+CKRpvpfB87UNCIJAe4sDKDJzYuPQNPtxAEAul9Pec7QX2F0hpMKKCVOwZurDVx/r6xvQ3uUA7nGuVHg0UY4PZzSiwv3vY18Qhujp7dXev2sBTB6XwcKqSZg6vgxJx73jf98rC2gt6BdfDBxhoTxWgsZMNaYmMyMec/FCJ5SBi8DIA6gpKcXauQuwqHpy1KciI5sdQGdXFyxH/+WLNIDZmSo0NS5Byo1HeRpScrk8/m49CwUg7nnae5EFUFNSyi++YT09fThzrg1SSgBAaTKhvRlZAGsaHuMX35DBwRzaL3agvz979TEBoCyT1t6OJIBaN4HqvgAnWk6iNJmA53lwbBtKiChOd/9RCmEYIu/7yGYH4fv+sEPS6TRcN6Z9qkgCeDBRDgDI533k88OfPNPjOA5qayoxGA5pb0VyJ7DOTUYxywAIYWFS/UQ4joMzA33ae5G8A8QF32GOguM4mFQ/EckrF39Hus7rb2ovjKDg2RAADPxgheHyBV86nUZtTSWcaz77/9z2p/Z2JAGcVT5mzpiGnt5eZPsHkC/4CIOQg7hNQgjYtgXPi6M0mUBZJgXXvf7u6dGeDhzoOKt9rkgC2Hv+FIK5C1FVWYGqyoooTkGaVAqbft8HJVHQ3dL+Y62kDG98LBsU8EXLId1pdhOfHduPQ5faoCxoXwRoByAs0THS41ubD2O/gbcodr2m5kNoar7yn0visO6e/juAEHtGejxQEq/t/wF7zv+lewoGoCs/iDd/+wmbj/569TFb4EfdXe1rgDCu3nEG1XIIa9htvlwY4PUDu/Fk3TS8Mv0hzErz9cCdaunvwq7WE/j21B8YCK658SNldyDdHbr7Ru7NVmzbsFsoLB7tOM+2Ueq4cCz7lsdNTqZIf48QKIW+go+T2W5c8gdHPkjIty+++P4nuucy8imgo77wTOVppx2wUrc6zg9D+OHov2O7kMuOegxlSsq9HaUzPzWxZeaW3aJ1+ZhUj8hQ5Y3ssVs5UvCcZ7Fs2bBPX2Nh7J7tuZc/aAnz8RlKqTZTm2yY7wK7sKB3xbvdpgYj+X62cttHG5USqwSE/i8WGBTUQaWwrnPlWu2r/htF+gV91Zfrl0hYL1hAQ2iH40V4e98SKSGaBdAV5XO7pwkEQqFbWeqYlOKXrpXvHf+/nxJjjDHGGLuP/AMeZJVUQaGa2gAAAABJRU5ErkJggg==' });
        const gymkhana = await company.createGymkhana({ name: 'TestGymkhana',
          description: 'Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industrys standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. ', start: moment('2020/01/01', 'YYYY/MM/DD'), end: new Date(),
          image: 'data:image/png;base64,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', city: 'Alicante' });
        await user.addGymkhana(gymkhana);
        const phase = await gymkhana.createPhase({ name: 'TestPhase', description: 'Test', position: '', phaseOrder: 1, image: 'data:image/png;base64,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' });
        await user.addPhase(phase);
      }
    });
  }

  public getModels(): ISequelizeModels { return (this.mSequelize as any).models; }
  public getSequelize() { return this.mSequelize; }
}

const database = new Database();
export const models = database.getModels();
export const sequelize = database.getSequelize();
export const db = database;
